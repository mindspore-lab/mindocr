system:
  mode: 0 # 0 for graph mode, 1 for pynative mode in MindSpore
  distribute: True
  amp_level: "O3"
  seed: 42
  log_interval: 100
  val_while_train: True
  drop_overflow_update: False
  ckpt_max_keep: 5

common:
  character_dict_path: &character_dict_path
  num_classes: &num_classes 37 # num_chars_in_dict + 1
  max_text_len: &max_text_len 24
  infer_mode: &infer_mode False
  use_space_char: &use_space_char False
  batch_size: &batch_size 64

model:
  type: rec
  transform: null
  backbone:
    name: rec_resnet34
    pretrained: False
  neck:
    name: RNNEncoder
    hidden_size: 256
  head:
    name: CTCHead
    weight_init: crnn_customised
    bias_init: crnn_customised
    out_channels: *num_classes

postprocess:
  name: RecCTCLabelDecode
  character_dict_path: *character_dict_path
  use_space_char: *use_space_char

metric:
  name: RecMetric
  main_indicator: acc
  character_dict_path: *character_dict_path
  ignore_space: True
  print_flag: False

loss:
  name: CTCLoss
  pred_seq_len: 25
  max_label_len: *max_text_len # this value should be smaller than pre_seq_len
  batch_size: *batch_size

scheduler:
  scheduler: warmup_cosine_decay
  min_lr: 0.0
  lr: 0.0005
  num_epochs: 30
  warmup_epochs: 1
  decay_epochs: 29

optimizer:
  opt: adamw
  filter_bias_and_bn: True
  momentum: 0.95
  weight_decay: 0.0001
  nesterov: False

loss_scaler:
  type: static
  loss_scale: 512

train:
  ckpt_save_dir: "./tmp_rec"
  pred_cast_fp32: False # let CTCLoss cast internally
  dataset_sink_mode: False
  dataset:
    type: LMDBDataset
    dataset_root: path/to/data_lmdb_release/ # Optional, if set, dataset_root will be used as a prefix for data_dir
    data_dir: training/
    label_file: null # not required when using LMDBDataset
    sample_ratio: 1.0
    shuffle: True
    transform_pipeline:
      - Decode:
      - RecCTCLabelEncode:
          max_text_len: *max_text_len
          character_dict_path: *character_dict_path
          use_space_char: *use_space_char
          lower: True
      - RecResizeImg:
          image_shape: [32, 100] # H, W
          infer_mode: *infer_mode
          character_dict_path: *character_dict_path
          padding: False # aspect ratio will be preserved if true.
      - Normalize:
          mean: [127.0, 127.0, 127.0]
          std: [127.0, 127.0, 127.0]
      - HWC2CHW:
    #  the order of the dataloader list, matching the network input and the input labels for the loss function, and optional data for debug/visaulize
    output_columns: ["image", "text_seq"]
    net_input_column_index: [0] # input indices for network forward func in output_columns
    label_column_index: [1] # input indices marked as label

  loader:
    shuffle: True
    batch_size: *batch_size
    drop_remainder: True
    max_rowsize: 12
    num_workers: 1
    num_workers_dataset: 1
    using_multiprocess_for_pipeline: False

eval:
  ckpt_load_path: ./tmp_rec/best.ckpt
  dataset_sink_mode: False
  dataset:
    type: LMDBDataset
    dataset_root: path/to/data_lmdb_release/
    data_dir: validation/
    label_file: null # not required when using LMDBDataset
    sample_ratio: 1.0
    shuffle: False
    transform_pipeline:
      - Decode:
      - RecCTCLabelEncode:
          max_text_len: *max_text_len
          character_dict_path: *character_dict_path
          use_space_char: *use_space_char
          lower: True
      - RecResizeNormForInfer:
          target_height: 32
          target_width: 100
          keep_ratio: False
          padding: False
          norm_before_pad: False
      - HWC2CHW:
    #  the order of the dataloader list, matching the network input and the input labels for the loss function, and optional data for debug/visaulize
    output_columns: ["image", "text_padded", "text_length"]
    net_input_column_index: [0] # input indices for network forward func in output_columns
    label_column_index: [1, 2] # input indices marked as label

  loader:
    shuffle: False
    batch_size: 64
    drop_remainder: False
    max_rowsize: 12
    num_workers: 4
    num_workers_dataset: 1

predict:
  ckpt_load_path: ./tmp_rec/best.ckpt
  vis_font_path: tools/utils/simfang.ttf
  dataset_sink_mode: False
  dataset:
    type: PredictDataset
    dataset_root: path/to/dataset_root
    data_dir: predict_result/crop
    # label_files: # not required when using LMDBDataset
    sample_ratio: 1.0
    shuffle: False
    transform_pipeline:
      - DecodeImage:
          img_mode: BGR
          to_float32: False
      - RecResizeImg:
          image_shape: [32, 100] # H, W
          infer_mode: *infer_mode
          character_dict_path: *character_dict_path
          padding: False # aspect ratio will be preserved if true.
      - NormalizeImage:
          bgr_to_rgb: True
          is_hwc: True
          mean: [127.0, 127.0, 127.0]
          std: [127.0, 127.0, 127.0]
      - ToCHWImage:
    #  the order of the dataloader list, matching the network input and the input labels for the loss function, and optional data for debug/visaulize
    output_columns: ["img_path", "image", "raw_img_shape"]

  loader:
    shuffle: False
    batch_size: 1
    drop_remainder: True
    max_rowsize: 12
    num_workers: 1
    num_workers_dataset: 1
    using_multiprocess_for_pipeline: False
