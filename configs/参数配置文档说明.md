# 配置文件参数说明

- [训练环境参数-system](#1-训练环境参数-system)
- [通用参数-common](#2-通用参数-common)
- [模型架构-model](#3-模型架构-model)
- [后处理-postprocess](#4-后处理-postprocess)
- [评估指标-metric](#5-评估指标-metric)
- [损失函数-loss](#6-损失函数-loss)
- [学习率调整策略和优化器(scheduler, optimizer, loss_scaler)](#7-学习率调整策略和优化器-scheduler-optimizer-loss_scaler)
  - [学习率调整策略-scheduler](#学习率调整策略-scheduler)
  - [优化器-optimizer](#优化器-optimizer)
  - [损失缩放-loss_scaler](#损失缩放系数-loss_scaler)
- [训练和评估流程(train, eval)](#8-训练和评估流程-train-eval)
  - [训练流程-train](#训练流程-train)
  - [评估流程-eval](#评估流程-eval)


本文档以 `configs/rec/crnn/crnn_resnet34.yaml` 为例，详细说明参数的用途。

## 1. 训练环境参数 (system)

| 字段 | 用途 | 默认值 | 可选值 | 备注 |
| ---- | ---- | ---- | ---- | ---- |
| mode | 设置运行编译模式 | 0 | 0/1 | 0: 表示在GRAPH_MODE模式中运行; 1: PYNATIVE_MODE模式 |
| distribute | 设置是否开启并行训练 | True | True / False | \ |
| amp_level | 设置混合精度模式 | O0 | O0/O1/O2/O3 | 'O0' - 不变化。<br> 'O1' - 将白名单内的Cell和运算转为float16精度，其余部分保持float32精度。<br> 'O2' - 将黑名单内的Cell和运算保持float32精度，其余部分转为float16精度。<br> 'O3' - 将网络全部转为float16精度。|
| seed | 随机算子 | 42 | Integer | \ |
| log_interval | 设置log输出间隔 | 100 | Integer | \ |
| val_while_train | 是否开启边训练边评估模式 | True | True/False | 如果值为True，请同步配置eval数据集 |
| drop_overflow_update | 出现溢出时，是否执行优化器 | True | True/False | 如果值为True，则出现溢出时不会执行优化器 |


## 2. 通用参数 (common)

因为同一个参数可能在不同的配置部分都需要重复利用，所以您可以在这个部分自定义一些通用的参数，以便管理。


## 3. 模型架构 (model)

在MindOCR中，模型的网络架构划分为 Transform, Backbone, Neck和Head四个部分。详细请参阅[文档](../mindocr/models/README.md)，以下是各部分的配置说明与例子：

| 字段 | 用途 | 默认值 | 备注 |
| :---- | :---- | :---- | :---- |
| type | 网络类型 | - | 目前支持 rec/det; rec表示识别任务，det表示检测任务 |
| **transform**| 配置变换方式 |  | 该部分仍在开发中 |
| name | 变换方式名字 | - | - |
| **backbone** | 配置骨干网络 ||
| name | 骨干网络类名 | - | 目前已定义的类有 rec_resnet34, rec_vgg7 及 det_resnet50. 亦可自定义新的类别，请参照文档指示定义。 |
| pretrained | 是否使用预训练模型 | False | 可支持本地checkpoint路径或url |
| **neck** | 配置网络Neck | |
| name | Neck类名 | - | 目前已定义的类有 RNNEncoder 及 DBFPN. 亦可自定义新的类别，请参照文档指示定义。 |
| hidden_size | RNN隐藏层单元数 | - | \ |
| **head** | 设置网络预测头 | |
| name | Head类名 | - | 目前支持CTCHead, DBHead |
| weight_init | 设置权重初始化 | 'normal' | \ |
| bias_init | 设置权偏差初始化 | 'zeros' | \ |
| out_channels | 设置分类数 | - | \ |


## 4. 后处理 (postprocess)

代码位置请看： [mindocr/postprocess](../mindocr/postprocess/)

| 字段 | 用途 | 默认值 | 备注 |
| :---- | :---- | :---- | :---- |
| name | 后处理类名 | - | 目前支持 DBPostprocess, RecCTCLabelDecode |
| character_dict_path | 识别字典路径 | None | 若值为None, 则使用默认字典[0-9a-z] |
| use_space_char | 设置是否添加空格到字典 | False | True/False | 


## 5. 评估指标 (metric)

代码位置请看： [mindocr/metrics](../mindocr/metrics)

| 字段 | 用途 | 默认值 | 备注 |
| :---- | :---- | :---- | :---- |
| name | 评估指标类名 | - | 目前支持 RecMetric, DetMetric | 
| main_indicator | 主要指标，用于最优模型的比较 | hmean | 识别任务使用acc，检测任务建议使用f-score |
| character_dict_path | 识别字典路径 | None | 若值为None, 则使用默认字典[0-9a-z] |
| ignore_space | 是否过滤空格 | True | True/False |
| print_flag | 是否打印log | False | 如设置True，则输出预测结果和标准答案等信息 |


## 6. 损失函数 (loss)

代码位置请看： [mindocr/losses](../mindocr/losses)

| 字段 | 用途 | 默认值 | 备注 |
| :---- | :---- | :---- | :---- |
| name | 损失函数类名 | - | 目前支持 CTCLoss, L1BalancedCELoss |
| pred_seq_len | 预测文本的长度 | 26 | 由网络架构决定 |
| max_label_len | 最长标签长度 | 25 | 数值应小于网络预测文本的长度 |
| batch_size | 单卡批量大小 | 32 | \ |


## 7. 学习率调整策略和优化器 (scheduler, optimizer, loss_scaler)

### 学习率调整策略 (scheduler)

代码位置请看： [mindocr/scheduler](../mindocr/scheduler)

| 字段 | 用途 | 默认值 | 备注 |
| :---- | :---- | :---- | :---- |
| scheduler | 学习率函数名 | 'constant' | 目前支持 'constant', 'cosine_decay', 'step_decay', 'exponential_decay', 'polynomial_decay', 'multi_step_decay' |
| min_lr | 学习率最小值 | 1e-6 | 以'cosine_decay'为例，学习率根据cosine函数先递增后衰减，`min_lr`表示学习率的递增的初始值及衰减的终止值|
| lr | 学习率峰值 | 0.01 | 以'cosine_decay'为例，`lr`表示学习率递增的最大值，随后学习率开始衰减 |
| num_epochs | 最大训练epoch数 | 200 | 完整一次训练所需要遍历所有数据的次数 |
| warmup_epochs | 学习率递增epoch数 | 3 | 以'cosine_decay'为例，`warmup_epochs`表示学习率递增的总步长，假设值为N，即代表前N个epoch，学习率递增，随后开始衰减 |
| decay_epochs | 学习率递减epoch数 | 10 | 以'cosine_decay'为例，`decay_epochs`表示学习率衰减的总步长，假设值为M，即代表从倒数第M个epoch开始，学习率衰减 |


### 优化器 (optimizer)

代码位置请看： [mindocr/optim](../mindocr/optim)

| 字段 | 用途 | 默认值 | 备注 |
| :---- | :---- | :---- | :---- |
| opt | 优化器名 | 'adam' | 目前支持'sgd', 'nesterov', 'momentum', 'adam', 'adamw', 'lion', 'rmsprop', 'adagrad', 'lamb'. 'adam' |
| filter_bias_and_bn | 设置是否排除bias和batch norm的权重递减 | True | True/False | 
| momentum | 动量 | 0.9 | \ |
| weight_decay | 权重递减率 | 0 | 在损失函数中，`weight_decay`是放在正则项前面的一个系数，降低权重可减低模型复杂度，避免网络的过拟合 |
| nesterov | 是否启用Nesterov动量 | False | True/False |


### 损失缩放系数 (loss_scaler)

| 字段 | 用途 | 默认值 | 备注 |
| :---- | :---- | :---- | :---- |
| type | 损失缩放管理类型 | static | 目前支持 static, dynamic |
| loss_scale | 损失缩放系数 | 1.0 | \ |


## 8. 训练、评估和推理流程 (train, eval, predict)

训练流程的配置放在 `train` 底下，评估阶段的配置放在 `eval` 底下。注意，在模型训练的时候，若打开边训练边评估模式，即val_while_train=True时，则在每个epoch训练完毕后按照 `eval` 底下的配置运行一次评估。在非训练阶段，只运行模型评估的时候，只读取 `eval` 配置。


### 训练流程 (train)

| 字段 | 用途 | 默认值 | 备注 |
| :---- | :---- | :---- | :---- |
| ckpt_save_dir | 设置模型保存路径 | ./tmp_rec | \ |
| dataset_sink_mode | 数据是否直接下沉至处理器进行处理 | - | 如果设置True，则数据下沉至处理器，至少在每个epoch结束后才能返回数据 |
| **dataset** | 数据集配置 | 详细请参阅[Data文档](../mindocr/data/README.md) ||
| type | 数据集类名 | - | 目前支持 LMDBDataset, RecDataset 和 DetDataset |
| dataset_root | 数据集所在根目录 | None | Optional |
| data_dir | 数据集所在子目录 | - | 如果没有设置`dataset_root`，请将此设置成完整目录 |
| label_file | 数据集的标签文件路径 | - | 如果没有设置`dataset_root`，请将此设置成完整路径，否则只需设置子路径 |
| sample_ratio | 数据集抽样比率 | 1.0 | 若数值<1.0，则随机选取 |
| shuffle | 是否打乱数据顺序 | 在训练阶段为True，否则为False | True/False |
| transform_pipeline | 数据处理流程 | None | 详情请看 [transforms](../mindocr/data/transforms) |
| output_columns | 每条数据特征名 | None | 如果值为None，则输出所有列 |
| net_input_column_index | output_columns中，属于网络construct函数的输入项的索引 | [0] | \ |
| label_column_index | output_columns中，属于loss函数的输入项的索引 | [1] | \ |
| **loader** | 数据加载设置 ||
| shuffle | 每个epoch是否打乱数据顺序 | 在训练阶段为True，否则为False | True/False |
| batch_size | 单卡的批量大小 | - | \ |
| drop_remainder | 当数据总数不能除以batch_size时是否丢弃最后一批数据 | 在训练阶段为True，否则为False | True/False |
| max_rowsize | 指定在多进程之间复制数据时，共享内存分配的最大空间 | 64 | \ |
| num_workers | 指定 batch 操作的并发进程数/线程数 | n_cpus / n_devices - 2 | 该值应大于或等于2 |


### 评估流程 (eval)

`eval` 的参数与 `train` 基本一样，只补充说明几个额外的参数，其余的请参考上述`train`的参数说明。

| 字段 | 用途 | 默认值 | 备注 |
| :---- | :---- | :---- | :---- |
| ckpt_load_path | 设置模型加载路径 | - | \ |
| num_columns_of_labels | 设置数据集输出列中的标签数 | None | 默认假设图像 (data[1:]) 之后的列是标签。如果值不为None，即image(data[1:1+num_columns_of_labels])之后的num_columns_of_labels列是标签，其余列是附加信息，如image_path。 |
| drop_remainder | 当数据总数不能除以batch_size时是否丢弃最后一批数据 | 在训练阶段为True，否则为False | 在做模型评估时建议设置成False，若不能整除，mindocr会自动选择一个最大可整除的batch size |


### 推理流程 (predict)

`predict` 的参数与 `train` 基本一样，只补充说明几个额外的参数，其余的请参考上述`train`的参数说明。

| 字段 | 用途 | 默认值 | 备注 |
| :---- | :---- | :---- | :---- |
| ckpt_load_path | 设置模型加载路径 | - | \ |
| vis_font_path | 推理结果视觉展示的字体加载路径 | tools/utils/simfang.ttf | \ |
